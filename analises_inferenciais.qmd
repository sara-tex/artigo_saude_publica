---
title: "analises_inferenciais"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(ggrepel)
library(rstatix)
library(summarytools)
library(nortest)
library(MKinfer)
library(boot)
library(purrr)
#library(emmeans)
#library(easystats)
```

```{r}
#importando o dataframe

df <- read_csv("dados-limpo.csv") |> 
  filter(nivel_atencao %in% c("atenção primária", "atenção secundária", "atenção terciária"))
```

```{r}
#proporção de gênero (isso é pra ficar nas descritivas)

df |> 
  count(genero) |> 
  mutate(
    prop = n / sum(n) * 100
  )

## 2.1 Preparação de Dados para Teste t (Gênero)
vinculos_unicos <- df |> 
  filter(!is.na(genero)) |> 
  group_by(codigo_profissional_saude, genero) |> 
  summarise(
    n_vinculos = n(), 
    .groups = 'drop'
  )

## 2.2 Testando Pressupostos para n_vinculos ~ genero
### Normalidade
norm_mulher_t <- vinculos_unicos |>
  filter(genero == "Female") |> 
  pull(n_vinculos) |> 
  lillie.test()
norm_homens_t <- vinculos_unicos |> 
  filter(genero == "Male") |> 
  pull(n_vinculos) |> 
  lillie.test()

### Homogeneidade de Variâncias
levene_t_vinculos <- levene_test(vinculos_unicos, formula = n_vinculos ~ genero)

## 2.3 Teste t com Bootstrap
boot_t_vinculos <- boot.t.test(formula = n_vinculos ~ genero, data = vinculos_unicos, 
                              R= 1000)

descritiva_t_genero <- vinculos_unicos |>
  group_by(genero) |>
  get_summary_stats(n_vinculos, type = "mean_sd")
```

```{r}
# teste t para gênero
## testando pressupostos

### normalidade
norm_mulher <- vinculos_unicos |>
  filter(genero == "Female") |> 
  pull(n_vinculos) |> 
  lillie.test()

norm_homens <- vinculos_unicos |> 
  filter(genero == "Male") |> 
  pull(n_vinculos) |> 
  lillie.test()

### homogeneidade de variâncias
levene_test(vinculos_unicos, formula = n_vinculos ~ genero)

### bootstrap
boot_t_vinculos <- boot.t.test(formula = n_vinculos ~ genero, data = vinculos_unicos, 
                     R= 1000)
```


Usando o pacote genderBR, categorizou-se 59.286 vínculos como de mulheres ("Female"), 11.492 eram homens ("Male"), mas não foi possível categorizar 2.745 vínculos quanto ao gênero, sendo estes excluódos do banco de dados para proceder à análise da diferença de média por meio do teste t de Student.

Em razão do não atendimento ao pressuposto de normalidade, procedeu ao procedimento de bootstrap com 1000 reamostragens para verficar se há uma média de vinculos maior para homens ou mulheres. Constatou-se diferença estatisticamente significativa entre os grupos (t (13081) = -2,3965; p-value = 0.01657), no sentido de que há um número de médio maior para os homens do que para as mulheres. 



```{r}
# quantidade de psicólogos em cada região por nível de atenção (descritivas)
df |> 
  count(regiao, nivel_atencao) |> 
  pivot_wider(names_from = nivel_atencao, values_from = n, id_cols = regiao) 
```

```{r}
## 3.1 Tabela de Contingência
tabela_qui_regiao <- table(df$regiao, df$nivel_atencao)

## 3.2 Teste Qui-quadrado
result_qui_regiao <- chisq.test(tabela_qui_regiao)

## 3.3 Resíduos Padronizados
residuos_qui_regiao <- result_qui_regiao$stdres
idu```

```{r}
#variável de proporção: "nº de habitantes por profissional de psicologia"
## agrupando por estado 

df_prop_muni <- df |>
  group_by(codigo_municipio, nome_do_municipio, regiao, estado) |> 
  summarise(
    populacao_muni = first(populacao_muni), 
    quanti_psis_muni = n(), 
    prop_psi_muni =  populacao_muni/quanti_psis_muni,
    .groups = 'drop'
  ) |>
  ungroup()

## Agrupando por estado
df_prop_estado <- df |>
  group_by(estado, regiao) |> 
  summarise(
    populacao_estado = sum(populacao_muni, na.rm = TRUE),
    quanti_psis_estado = n(),
    prop_psi_estado =  populacao_estado / quanti_psis_estado,
    .groups = 'drop'
  ) |>
  ungroup()
```

```{r}
# Anova entre regiões (proporção por região)

modelo_regiao <- aov(prop_psi_muni ~ regiao, data = df_prop)

summary(modelo_regiao)

TukeyHSD(modelo_regiao) 

# testando pressuposto de normalidade de resíduos
lillie.test(residuals(modelo_regiao))

# testando homogeneidade de variâncias
levene_test(prop_psi_muni ~ regiao, data = df_prop)

# estatística descritiva
descritiva_anova <- df_prop |> 
  group_by(regiao) |> 
  get_summary_stats(
    prop_psi_muni,
    type = "full") |> 
  select(regiao, n, mean, sd)

# Anova de Welch (robusta à falta de homogeneidade de variância)
welch_anova <- welch_anova_test(prop_psi_muni ~ regiao, 
                           data = df_prop)

# tamanho de efeito global Eta Quadrado
efeito_global_anova <- effectsize::omega_squared(modelo_regiao, alternative = "two.sided")

# Teste Post-Hoc de Games-Howell
post_hoc_anova <- df_prop |> 
  games_howell_test(prop_psi_muni ~ regiao) 

# tamanho de efeito das comparações 
efeito_regioes <- df_prop |> 
  cohens_d(prop_psi_muni ~ regiao,
           paired = F,
           hedges.correction = T) 

# Bootstrap (DEU ERRO NO TAMANHO DE EFEITO)
set.seed(123) # Para reprodutibilidade
marginal_means <- parameters::bootstrap_model(modelo_regiao, iterations = 2000) |> 
  emmeans::emmeans( ~ regiao)

contrastes <- marginal_means |> 
 emmeans::contrast( method = "pairwise",  adjust = "holm") |> 
  parameters::parameters(bootstrap = TRUE, ci_method = "bci")

# tamanho de efeito com reamostragem
set.seed(123)
efeito_anova_boot <- cohens_d(data = df_prop, prop_psi_muni ~ regiao, var.equal = F, ci = T, ci.type = "bca", nboot = 2000)
```

```{r}
# ANOVA fatorial da distribuição de psicólogos considerando nivel de atenção e região
```

Não houve normalidade dos resíduos nem homogeneidade de variâncias. 

centro-oeste tem menos psicólos por população do que o sudeste proporcionalmente
nordeste tem mais psicólogos por população que o norte
nordeste tem menos psicólogos por pop do que o sudeste
nordeste tem menos psicólogos por pop do que o sul
norte tem menos psicólogos por pop do que o sudeste

norte tem menos psicólogos por pop do que o sul
e o sudeste tem menos psicólogos por população do que o sul

#verificar a prevalência de psicólogos por nível de atenção em cada região (ex.: nordeste tem mais psicólogos na atenção primária que sudeste?)

Procedeu-se a uma análise de correlação no sentido de avaliar a relação entre a população do município e a proporção da quantidade de habitantes por psicólogo. Em razão do não atendimento do pressuposto de normalidade, foi realizada o teste de correlação de Spearman, cuja resultado indicou associação positiva e significativa (r(5484) = 0,33; p < 0,001), o que sugere que quanto mais pessoas residem no município, maior a demanda que os profissionais precisam atender. 

```{r}
## 5.1 Testando Pressupostos (Normalidade)
norm_pop_muni <- df_prop_estado |> 
  pull(populacao_estado) |> 
  lillie.test()

norm_prop_psi_muni <- df_prop_estado |> 
  pull(prop_psi_estado) |> 
  lillie.test()

## 5.2 Teste de Correlação de Spearman
corr_spearman <- cor.test(df_prop_estado$populacao_estado, df_prop_estado$prop_psi_estado, method = "spearman")
```

```{r}
#Visualização da correlação

library(ggplot2)

ggplot(df_prop_estado, aes(x = populacao_estado, y = prop_psi_estado)) +
  geom_point(alpha = 0.6, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "gray") + 
  geom_text_repel(
    data = df_prop_estado |> slice_max(populacao_estado, n = 5),
    aes(label = estado), 
    size = 3, 
    box.padding = 0.5, 
    point.padding = 0.5,
    color = "black",
    max.overlaps = Inf) +labs(
    title = "Correlação entre População e Psicólogos",
    x = "População do Município",
    y = "Cobertura de Psicólogos"
  ) +
  theme_minimal()
```