---
title: "Anova-fatorial"
format: html
editor_options: 
  chunk_output_type: console
---

# Preparação

Carregando os pacotes necessários e funções para formatar tabelas e gráficos.

```{r setup}
#| include: FALSE
# Instale e carregue os pacotes necessários
pacman::p_load(haven, tidyverse, easystats, afex, emmeans, rstatix, flextable, ggbeeswarm, qqplotr, ggpubr)

# Para estabelecer o padrão do documento
knitr::opts_chunk$set(echo = FALSE)

# Para formatar tabelas
options(digits = 3)
set_flextable_defaults(decimal.mark = ",", big.mark = " ")

# Estabelecer tema para gráficos
theme_set(theme_minimal())
```

Carregando os dados

```{r}
library(effectsize)
library(janitor)
```


```{r}
df <- read_csv("dados-limpo.csv") |> 
  as_factor() |> 
  filter(nivel_atencao %in% c("atenção primária", "atenção secundária", "atenção terciária"))
```

## Limpeza de banco de dados
```{r}
df_af <- df |> 
  group_by(codigo_municipio, nome_do_municipio, regiao, estado, nivel_atencao) |> 
  summarise(
    populacao_muni = first(populacao_muni), 
    quanti_psis_muni = n(), 
    prop_psi_muni =  populacao_muni/quanti_psis_muni,
    .groups = 'drop'
  ) |>
  ungroup()
```

```{r}
df_af <- df_af |> 
  select(prop_psi_muni, nivel_atencao, regiao)
```

## Estatísticas descritivas

```{r}
descritivos <- df_af |> 
  group_by(regiao, nivel_atencao) |> 
  get_summary_stats(type = "common")

flextable(descritivos) |> 
  autofit() |> 
  set_caption("Estatísticas descritivas")

df_af <- mutate(df_af, ID= 1:nrow(df_af), .before= 1)
```


# Modelo de anova fatorail
```{r}
# Melhor forma
modelo <- aov_ez(id = "ID",dv = "prop_psi_muni", 
                 between = c("nivel_atencao", "regiao"), data = df_af)

tabela_anova <- parameters(modelo, effectsize_type = "eta", partial = TRUE) |> 
  as_tibble() |> 
  clean_names() |> 
  select(-method,
         -mean_square)

tabela_completa <- omega_squared(modelo, partial = T) |> 
  as_tibble() |> 
  clean_names() |> 
  left_join(y = tabela_anova) |> 
  select(-ci,
         -ci_low,
         -ci_high) |> 
  relocate(omega2_partial, .after = p)
```

### Checando pressupostos

```{r}

residuos <- residuals(modelo)

# Teste de normalidade dos resíduos
normalidade_res <- nortest::lillie.test(residuos) 

# Avaliando homogeneidade de variância
homogeneidade <- levene_test(prop_psi_muni ~ nivel_atencao*regiao, data = df_af)

autocorr <- car::durbinWatsonTest(modelo$lm)
```

## Contrastes das médias marginais com bootstrapping

### Efeitos de interação

```{r}
#| cache: TRUE

set.seed(123) # Para reprodutibilidade
modelo_boot <- bootstrap_model(modelo$lm, iterations = 2000)

medias_marginais_globais <- emmeans(modelo_boot, ~ nivel_atencao)

contr_nivel_atencao <- medias_marginais_globais |> 
  contrast(method = "pairwise") |> 
  parameters(bootstrap = TRUE, ci_method = "bci")
```

#### Tamanho de efeito das diferenças entre os grupos

```{r}
#| cache: TRUE

# Tamanho de efeito condicional sexo
set.seed(123) # Para reprodutibilidade

boot_contrastes <- model_parameters(
  contrast(emmeans(modelo, ~ nivel_atencao), method = "pairwise"), 
  bootstrap = TRUE, 
  iterations = 2000, 
  ci_method = "bca")

set.seed(123) # Para reprodutibilidade
marginal_means <- bootstrap_model(modelo$lm, iterations = 2000) |>  
  emmeans( ~ nivel_atencao*regiao)

# Efeitos condicionais para nivel de atenção
contr_cond_nivel_atencao <- marginal_means |>  
  contrast(method = "pairwise", by = "nivel_atencao") |>  
  parameters(bootstrap = TRUE, ci_method = "bci")

# Efeitos condicionais para região
contr_cond_regiao <- marginal_means |>  
  contrast(method = "pairwise", by = "regiao") |> 
  parameters(bootstrap = TRUE, ci_method = "bci")
```

# Tamanho de efeito
```{r}
# Tamanho de efeito condicional nivel de atenção
set.seed(123) # Para reprodutibilidade
d_cond_nivel_atencao <- df_af |>
  group_by(regiao) |> 
  cohens_d(prop_psi_muni ~ nivel_atencao, var.equal = F, ci = T, ci.type = "perc", nboot = 2000)

# Tamanho de efeito condicional região
set.seed(123) # Para reprodutibilidade
d_cond_Estciv <- df_af |> 
  group_by(nivel_atencao) |>  
  cohens_d(prop_psi_muni ~ regiao, var.equal = F, ci = T, ci.type = "perc", nboot = 2000)
```


# Reporte

## Procedimentos de análise

Foi realizada uma ANOVA fatorial (3x5) para avaliar em que medida a cobertura de psicólogos difere entre os níveis assistenciais (primário, secundário e terciário) a depender da região (Centro-Oeste, Norte, Nordeste, Sudeste e Sul). A normalidade dos resíduos foi analisada por meio do teste de Kolmogorov-Smirnov com correção de Lilliefors e a homogeneidade de variâncias foi avaliado pelo teste de Levene. Realizaram-se análises dos contrastes para os efeitos principais e de interação (nível assistencial*região) a partir das médias marginais estimadas. Procedimentos de bootstrapping (2000 re-amostragens; 95% IC BCa) foram implementados para se obter uma maior confiabilidade dos resultados, corrigir desvios de normalidade da distribuição da amostra e diferenças entre os tamanhos dos grupos e para apresentar um intervalo de confiança de 95% para as diferenças entre as médias (Haukoos & Lewis, 2005). A análise foi realizada no software R (R Core Team, 2025)

## Resultados

Os testes de Kolmogorov-Smirnov com correção de Lilliefors (*D* = 0,2; *p* \< 0,001) e o teste de Levene (*F*(14, 9966)= 81; *p* \< 0,001) indicaram, respectivamente, a ausência de normalidade dos resíduos e de homogeneidade de variâncias.

Os resultados da ANOVA demonstraram que houve um efeito estatisticamente significativo para nível de atenção (*F*(2, 9966) = 594,7; *p* \< 0,001, *partial* ω² = 0,106), para região (*F*(4, 9966) = 29,640; *p* \< 0,001, *partial* ω² = 0,011) e para a interação entre estas duas variáveis (*F*(8, 9966 ) = 15,167, *p* \< 0,001, *partial* ω² = 0,011).

```{r}
tabela_completa |>  
  flextable() |> 
  colformat_double(digits = 2) |> 
  autofit() |> 
  set_caption("Resultados da ANOVA Fatorial")
```

Em relação à interação (nível de atenção\*região), mulheres apresentaram escores significativamente maiores que os homens em todas as comparações, exceto para o grupo de casados (i.e., mulheres solteiras eram mais felizes que homens solteiros; mulheres namorando/noivas eram mais felizes que homens namorando/noivos e mulheres casadas obtiveram os mesmos níveis de felicidade do que homens casados).

Os resultados também demonstraram que os níveis de felicidade das mulheres independiam do seu estado civil. Já para homens, todas as comparações foram estatisticamente significativas, de modo que homens casados eram mais felizes que homens namorando/noivos e homens solteiros, e homens namorando/noivos eram mais felizes que homens solteiros (Ver Tabela 3).

```{r}
# gráfico da interação
# boxplot
```

Houve diferença significativa entre a cobertura de psicólogos da atenção primária com a terciária [IC BCa 95% -16328, -14507; *p* \ p< 0,001] e da secundária com a terciária [IC BCa 95% -16112, -14156; *p* \ p< 0,001]. Entretanto, não foram encontradas diferenças significativas entre a primária e secundária [IC BCa 95% -997, 430; *p* \ p= 0,716]. 
 
```{r}
# tabela com post hoc
```



# Referências

Haukoos, J. S., & Lewis, R. J. (2005). Advanced statistics: Bootstrapping confidence intervals for statistics with “difficult” distributions. Academic Emergency Medicine, 12(4), 360-365. <doi:10.1197/j.aem.2004.11.018>

R Core Team (2023). *R: A Language and Environment for Statistical Computing*. R Foundation for Statistical Computing, Vienna, Austria. <https://www.R-project.org/>
